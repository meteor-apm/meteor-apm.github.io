<!DOCTYPE html>
<html lang='en'>
<head>
  
    <meta charset="UTF-8">
  <title>Reducing PubSub Data Usage - Meteor APM Academy</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="//use.typekit.net/ypr5vji.js"></script>
  <script src="/scripts.js"></script>
  <script>try{Typekit.load();}catch(e){}</script>
</head>
<body>
  
  
    <header id="topbar">
    <div class="container">
      <a href="/" class="logo">Meteor APM</a>
      <nav class="menu">
        
          
            <a href="http://support.meteorapm.com/knowledgebase">Docs</a>
          
        
          
            <a href="/blog">Blog</a>
          
        
          
            <a class="current" href="/academy">Academy</a>
          
        
          
            <a href="http://support.meteorapm.com/forums/224274-general">Support</a>
          
        
      </nav>
    </div>
  </header>

  <section id="main">
    <a href="http://mad.ly/signups/106626/join" class="subscribe">Subscribe to Academy</a>
    <article class="post post-container">
  <h1>Reducing PubSub Data Usage</h1>
  <p>Publications are the main place where your app sends data to the client when a client subscribes to it. Meteor caches a copy of each client’s data in the server’s memory. For example, let’s say a single client has  approximately 2MB of subscription data. If you have 1000 concurrent clients connecting to your app, Meteor caches approximately 2GB (2MB * 1000) of client data in the server’s memory.</p>

<p>If your app sends a large amount of data, it will take a considerable amount of time for it to reach the client (especially when utilizing mobile networks). So it is very important to reduce the amount of data your app sends to clients. Let’s see what we can do about it.</p>

<blockquote>
  <p>We’ve recently find out that fetching a lot of data (~1 MB per each subscription) from the DB and sending them to the client takes considerable amount of CPU. This will lead to a major bottleneck in your app’s scalability.</p>

  <p>(I’ll talk more about this in another article)</p>
</blockquote>

<h2 id="use-field-filtering">Use Field Filtering</h2>

<p>Most of the time, you don’t need to publish all the fields of the MongoDB documents. Try using field filtering to remove the data your client doesn’t need. For example, imagine your app is a blog, and a typical blog post looks like this in the MongoDB:</p>

<pre><code>{
  "_id": "this is the id",
  "title": "This is my summery",
  "content": "This is my content and it is very very long"
}
</code></pre>

<p>Your home page contains a list of all blog posts and their titles. This is the publication for that.</p>

<pre><code>Meteor.publish('getTitles', function() {
  return Posts.find();
});
</code></pre>

<p>In this case, you are also sending <code>content</code> to the client, but the client actually does not need the <code>content</code> field. Thus, the optimized version ignores the <code>content</code> by using field filtering.</p>

<pre><code>Meteor.publish('getTitles', function() {
  return Posts.find({}, {fields: {title: 1}});
});
</code></pre>

<p>Use Meteor Documentation to learn more about <a href="http://docs.meteor.com/#fieldspecifiers">field filtering</a>.</p>

<h2 id="restructure-your-application">Restructure Your Application</h2>

<p>Using small modifications, you can greatly reduce the amount of data you send to the client. Let’s say you have 200 articles on your blog, and you are sending all of the titles to the client. However, in this case, let’s say your users only need to know about the more recent articles, so instead you can send the last 20 articles instead of all of them. Making this change reduces the required memory by a factor of 10. The following example shows how to execute this modification:</p>

<pre><code>Meteor.publish('getTitles', function() {
  return Posts.find({}, {fields: {title: 1}, limit: 20});
});
</code></pre>

<p>This is just an example. You can use paginations or implement a similar technique. Refer to this MeteorPedia <a href="http://www.meteorpedia.com/read/Infinite_Scrolling">article</a> for implementing paginations with Meteor.</p>

<h2 id="restructure-your-data">Restructure Your Data</h2>

<p>What if you want a content summary along with the title for your blog posts? In this case, you may decide to send the <code>content</code> to the client too, and you can show a summary based on that to the client. This works, but there is better way.</p>

<p>You can create a summary when you are creating and editing the blog post and assign it to a new field called <code>summary</code>. Then you can send that field instead of content, reducing the amount of data usage. See below.</p>

<pre><code>Meteor.publish('getTitles', function() {
  return Posts.find({}, {fields: {title: 1, summary: 1}, limit: 20});
});
</code></pre>

<h2 id="counting-on-the-server-side">Counting On The Server Side</h2>

<p>Sometimes, specially when you are building dashboard and charts, you might need to count the number of documents for some queries. For that, you should not send documents to the client and do the counts on the client side. </p>

<p>Best way is to count them in the server side using a package like <a href="https://github.com/percolatestudio/publish-counts/">publish-counts</a>. Concept behind publish-counts is explained in <a href="http://stackoverflow.com/questions/14656567/meteor-subscribe-to-a-count">this</a> stack overflow question.</p>

<p>You may also consider using <a href="https://atmospherejs.com/?q=aggregate">MongoDB aggregation techniques</a> to get a summery of data and send them to the client.</p>

<p>These are only some of the tips you can use to save subscription data, save server memory usage, and reduce latency. Try applying some of these; you can verify the results from the <a href="http://support.meteorapm.com/knowledgebase/articles/347428-network-impact">Network Impact</a> metric in the Meteor APM.</p>

</article>
    <article class="container comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
      /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
      var disqus_shortname = 'meteorapm'; // required: replace example with your forum shortname

      /* * * DON'T EDIT BELOW THIS LINE * * */
      (function() {
          var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
          dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
          (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</article>
  </section>

    <footer id="footer">
    <div class="container">
      <nav class="menu">
        <a href="/terms_and_conditions.html">Terms of Service</a>
        <a href="/privacy_policy.html">Privacy Policy</a>
      </nav>
      <br style="clear:both">
    </div>
  </footer>

  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', 'UA-48364339-2', 'meteorapm.com');
    ga('send', 'pageview');
  </script>

</body>
</html>